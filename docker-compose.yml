services:
  postgres:
    image: postgres:16-alpine
    container_name: peta-core-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: peta
      POSTGRES_PASSWORD: peta123
      POSTGRES_DB: peta_mcp_gateway
    ports:
      - '${PETA_POSTGRES_PORT:-5433}:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U peta -d peta_mcp_gateway']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - peta-network

  peta-auth:
    image: petaio/peta-auth:latest
    container_name: peta-auth
    restart: unless-stopped
    ports:
      - '7788:7788'
    networks:
      - peta-network
    volumes:
      - peta-auth-data:/data

  # Peta Core service (uncomment when deploying)
  # peta-core:
  #   image: petaio/peta-core:latest
  #   container_name: peta-core
  #   restart: unless-stopped
  #   ports:
  #     - '${BACKEND_PORT:-3002}:3002'
  #   environment:
  #     - DATABASE_URL=postgresql://peta:peta123@postgres:5432/peta_mcp_gateway?schema=public
  #     - SKILLS_DIR=/data/skills
  #   volumes:
  #     - ./skills:/data/skills    # Skills directory (shared with skillsmcp)
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #   networks:
  #     - peta-network

  # Skills MCP server (uncomment when deploying)
  # skillsmcp:
  #   image: ghcr.io/dunialabs/mcp-servers/mcp-skills:1.0.0
  #   container_name: peta-skillsmcp
  #   restart: unless-stopped
  #   environment:
  #     - SKILLS_DIR=/app/skills
  #   volumes:
  #     - ./skills:/app/skills:ro  # Read-only mount of same skills directory
  #   networks:
  #     - peta-network

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: peta-core-cloudflared
    restart: unless-stopped
    command: tunnel --no-autoupdate run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN:-}
    networks:
      - peta-network
    volumes:
      - ./cloudflared:/etc/cloudflared

volumes:
  postgres_data:
    driver: local
  peta-auth-data:
    driver: local

networks:
  peta-network:
    driver: bridge
